# CVE-2022-42004 Analysis

## Vulnerability Details

| Field | Value |
|-------|-------|
| **CVE** | CVE-2022-42004 |
| **Affected Package** | `com.fasterxml.jackson.core:jackson-databind` |
| **Vulnerability** | Uncontrolled Resource Consumption (Resource Exhaustion via deeply nested arrays) |
| **Vulnerable Versions** | < 2.13.4 |
| **Fix Version** | >= 2.13.4 |

## Root Cause

| Component | Details |
|-----------|---------|
| **Source** | `net.logstash.logback:logstash-logback-encoder:7.2` |
| **Location** | `commons-observability/build.gradle.kts:3` |
| **Requests** | `jackson-databind:2.13.3` (vulnerable) |
| **Resolved to** | `2.19.4` (safe - via Gradle conflict resolution) |

### Affected Modules

The vulnerable transitive dependency `jackson-databind:2.13.3` is pulled into the following modules via `commons-observability`:

- commons-domain
- commons-framework
- commons-grpc
- commons-grpc-auth
- commons-health
- commons-idempotence
- commons-messaging-kafka
- commons-observability
- commons-outbox
- commons-outbox-modulith
- commons-temporal
- commons-test

### Dependency Path

```
com.fasterxml.jackson.core:jackson-databind:2.13.3 -> 2.19.4
└── net.logstash.logback:logstash-logback-encoder:7.2
    └── project :commons-observability
```

## Why GitLab Still Reports It

GitLab's dependency scanner parses the dependency tree and sees `2.13.3` declared as a transitive dependency, even though Gradle resolves it to `2.19.4` at runtime via conflict resolution.

## Fix Options

### Option A: Gradle Constraint (Current Approach)

```kotlin
// In build.gradle.kts
constraints {
    implementation("com.fasterxml.jackson.core:jackson-databind:2.13.4") {
        because("CVE-2022-42004: Resource exhaustion via deeply nested arrays requires >= 2.13.4")
    }
}
```

**Pros:**
- Technically correct - enforces minimum version
- Documents the CVE requirement

**Cons:**
- GitLab may still flag it (sees 2.13.3 in dependency tree)
- Doesn't remove the vulnerable declaration from transitive dependencies

### Option B: Upgrade logstash-logback-encoder (Recommended)

| Version | jackson-databind | Status |
|---------|------------------|--------|
| **7.2** (current) | 2.13.3 | Vulnerable |
| **8.0** | 2.17.2 | Safe |
| **8.1** | 2.18.3 | Safe, recommended |
| **9.0** | 3.0.1 | Jackson 3.x - breaking changes |

#### Suggested Change

In `commons-observability/build.gradle.kts`:

```kotlin
// From:
api("net.logstash.logback:logstash-logback-encoder:7.2")

// To:
api("net.logstash.logback:logstash-logback-encoder:8.1")
```

**Pros:**
- Removes vulnerable `2.13.3` from dependency tree entirely
- Satisfies GitLab's vulnerability scanner
- Cleaner fix

**Cons:**
- Requires testing for compatibility with newer version

## Verification Commands

Check jackson-databind version in any module:
```bash
./gradlew :commons-observability:dependencyInsight --dependency com.fasterxml.jackson.core:jackson-databind
```

Check all modules:
```bash
for project in commons-domain commons-framework commons-grpc commons-health commons-messaging-kafka commons-observability commons-rest commons-test; do
  echo "=== $project ==="
  ./gradlew :$project:dependencyInsight --dependency com.fasterxml.jackson.core:jackson-databind 2>/dev/null | grep -E "jackson-databind:[0-9]" | sort -u
done
```

## Conclusion

The current runtime is **safe** (resolves to 2.19.4), but GitLab flags the vulnerable transitive declaration. **Upgrading `logstash-logback-encoder` to 8.1** is the recommended fix as it eliminates the vulnerable dependency declaration entirely.