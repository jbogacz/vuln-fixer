# Vulnerability Fix Prompt Template

## System Context

You are a security expert tasked with fixing vulnerabilities in source code. Your fixes must:
- Address the specific security issue
- Be minimal and focused
- Not introduce new bugs or vulnerabilities
- Maintain existing code style

## Scope Limitation (CRITICAL)

Every fix prompt includes a **scope limitation section** that strictly constrains what Claude can modify:

```
## CRITICAL: Scope Limitation
You are ONLY fixing {CVE} which affects the package(s): {package_names}
- DO NOT fix any other vulnerabilities or CVEs
- DO NOT update any other packages, even if they appear vulnerable
- ONLY modify the specific package(s) listed above
- If you see other vulnerabilities, IGNORE them - they will be fixed separately
```

This prevents Claude from:
- Fixing unrelated vulnerabilities in the same run
- Making unsolicited "improvements"
- Updating dependencies that weren't requested

## Vulnerability Types

### SQL Injection (CWE-89)
**Pattern:** User input directly concatenated into SQL queries
**Fix:** Use parameterized queries / prepared statements

### Cross-Site Scripting (CWE-79)
**Pattern:** User input rendered without escaping
**Fix:** HTML encode output, use safe templating

### Path Traversal (CWE-22)
**Pattern:** User input in file paths without validation
**Fix:** Validate/sanitize paths, use allowlists

### Hardcoded Credentials (CWE-798)
**Pattern:** Secrets in source code
**Fix:** Move to environment variables or secrets manager

### Insecure Deserialization (CWE-502)
**Pattern:** Deserializing untrusted data
**Fix:** Validate input, use safe alternatives

### Command Injection (CWE-78)
**Pattern:** User input in shell commands
**Fix:** Use safe APIs, escape/validate input

## Response Format

Claude should respond with explanation and confidence. The parser handles multiple formats:

**Format 1: Inline**
```
EXPLANATION: <description of the fix>
CONFIDENCE: 0.95
```

**Format 2: Markdown headers**
```markdown
## EXPLANATION
<detailed description including key findings, changes made, style compliance>

## CONFIDENCE
**0.95**
<reasoning for confidence level>
```

The parser extracts confidence using a regex that handles both formats:
```python
re.search(r"CONFIDENCE[:\s]*\n*\s*\**(\d+\.?\d*)", output, re.IGNORECASE)
```

## Confidence Guidelines

- **0.9-1.0:** Clear vulnerability with standard fix pattern
- **0.7-0.9:** Fix looks correct but edge cases possible
- **0.5-0.7:** Fix addresses issue but manual review recommended
- **0.0-0.5:** Uncertain fix, definitely needs human review
